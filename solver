#!/bin/bash

report=()
pkgm=''
blacklist=()


push () {
	report=("${report[@]}" "$1")
}

function in_array() {
  local x

  ENTRY=$1
  shift 1
  ARRAY=( "$@" )
  [ -z "${ARRAY}" ] && return 1
  [ -z "${ENTRY}" ] && return 1
  
  for x in ${ARRAY[@]}; do
    [ "${x}" == "${ENTRY}" ] && return 0
  done
  
  return 1
}


# Sistema de paquetes utilizado
which_pkgm () {	
	if [[ ! -z $(which apt) ]]; then
		pkgm='apt'
		else 
			if [[ ! -z $(which dnf) ]]; then
				pkgm='dnf'	
			else
				if [[ ! -z $(which pacman) ]]; then
					pkgm='pacman'
				else
					if [[ ! -z $(which emerge) ]]; then
						pkgm='emerge'	
					fi	
				fi	
			fi	
	fi 	
}

# Drivers en lista negra
blacklist () {
	blacklist=$(cat /etc/modprobe.d/*blacklist* | egrep '^blacklist ' | cut -d' ' -f2)
}

#
### Solvers
#

# --OK
touchpad_nofunciona () {
	# Parsear xinput buscando "Touchpad"
	[[ -z $(xinput | grep -i touchpad) ]] && push "Touchad no detectado"

	# Buscar paquete xserver-xorg-input-synaptics
	if [[ $pkgm == "apt" ]]; then
		(apt list --installed  | grep xserver-xorg-input-synaptics) >/dev/null 2>&1
	 	[[ $? -ne 0 ]] && push "Falta paquete: xserver-xorg-input-synaptics"
	fi 

	# Parsear la linea GRUB_CMDLINE_LINUX_DEFAULT de /etc/default/grub en búsqueda de acpi=off por ejemplo
	(grep GRUB_CMDLINE_LINUX_DEFAULT /etc/default/grub | egrep '(acpi=off|acpi_os=!)') >/dev/null 2>&1
	[[ $? -eq 0 ]] && push "ACPI fue deshabilitado: $(grep GRUB_CMDLINE_LINUX_DEFAULT /etc/default/grub)"
}

# Reservado para @Leo 
wifi_nofunciona () {
	wireless_interfaces=$(iw dev | grep -i Interface | grep -o ' w[a-z0-9]*')
	wireless_interfaces_connected=$(cat /proc/net/wireless | awk '/:/  {print $1}' | cut -d':' -f1)

	# rfkill
	#ID TYPE      DEVICE      SOFT      HARD
	#0 wlan      phy0   unblocked unblocked
	#62 bluetooth hci0   unblocked unblocked
	#65 wlan      phy4   unblocked unblocked

	# lspci / lsusb
	#
}

# -- OK
bluetooth_nofunciona () {
	# Está bloqueado
	local soft_locked=$(rfkill | grep bluetooth | awk '{ print $4 }')
	local hard_locked=$(rfkill | grep bluetooth | awk '{ print $5 }')

	[[ "$soft_locked" != "unblocked" ]] && push "Hay un bluetooth bloqueado por soft"
	[[ "$hard_locked" != "unblocked" ]] && push "Hay un bluetooth bloqueado por hard"
}

# --OK
audio_nohay () {
	local hardware=$(lspci -v | grep -i -A7 audio  | grep -i 'Subsystem' | cut -d':' -f2)
	local driver_en_uso=$(lspci -v | grep -i -A7 audio  | grep 'Kernel driver in use' | cut -d':' -f2)
	local drivers=$(lspci -v | grep -i -A7 audio  | grep 'Kernel modules' | cut -d':' -f2)

	# No hay driver en uso?
	if [[ -z "$driver_en_uso" ]]; then
		push "Audio: no hay driver (drivers disponibles: $drivers, device: $hardware)"

		# Verifico que ningún driver esté blacklisted
		for driver in "${drivers[@]}"; do
			in_array "snd_hda_intel" "${blacklist[@]}"
			[[ $? -eq 0 ]] && push "Audio: $driver está en blacklist"
		done	
	fi

	# muted?
	muted=$(pacmd list-sinks | awk '/muted/ { print $2 }')
	(grep yes <<< $(echo $muted)) >/dev/null
	[[ $? -eq 0 ]] && echo "Hay un dispositivo de audio 'silenciado'"

	# aplicar algo de esto?
	# https://askubuntu.com/questions/1029502/no-audio-on-ubuntu-18-04
}

# -- OK
ejecucion_lenta () {
	local mem_ava=$(cat /proc/meminfo | grep MemAvailable | awk '{print $2}')	

	local free_space_root=$(df -h | awk '
		$6=="/" {
			print $4
		}
	')

	local free_space_root_h=$free_space_root

	free_space_root=${free_space_root/K/000}
	free_space_root=${free_space_root/M/000000}
	free_space_root=${free_space_root/G/000000000}
	free_space_root=${free_space_root/T/000000000000}

	# menos de 4Gb libres en /
	[[ $free_space_root -le 4000000000 ]] && push "Poco espacio ($free_space_root_h) en partición root"
	
	# Menos de 150Kb libres de RAM
	[[ $mem_ava -le 150000 ]] && push "Memoria disponible insuficiente ($mem_ava kb)"
}


which_pkgm ; [[ -z $pkgm ]] && push "Package management desconocido"
blacklist

# Ejecutados desde un menú o con cualquier otra GUI

ejecucion_lenta
touchpad_nofunciona
bluetooth_nofunciona
audio_nohay


# Imprimo reporte

for i in "${report[@]}"; do
    echo $i
done
